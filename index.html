<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Honey Meadow</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: linear-gradient(#c9f7c3, #f0fff0);
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    h1 { color: #444; text-align: center; margin: 10px; }

    /* Portrait play area (9:16), centered horizontally */
    .play-area {
      position: absolute;
      top: 60px;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      overflow: hidden;
    }

    /* HUD top-right */
    .stats {
      position: fixed;
      top: 10px; right: 12px;
      pointer-events: none;
      z-index: 10;
      font-size: clamp(12px, 1.8vw, 32px);
      color: #2b2b2b;
      opacity: 0.6;
      text-shadow: 0 1px 2px rgba(255,255,255,0.7);
      font-weight: 600;
    }
    .stats .value {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      padding-left: 6px;
    }

    /* Admin panel bottom-left */
    .admin-panel {
      position: fixed;
      bottom: 10px; left: 12px;
      z-index: 20;
      font-size: clamp(12px, 1.8vw, 28px);
      opacity: 0.8;
      pointer-events: auto;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      padding: 8px 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .admin-panel button {
      font-size: inherit;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      background: #ffb347;
      cursor: pointer;
      margin-top: 4px;
    }
    .admin-panel button:hover {
      background: #ffa500;
    }

    @keyframes pop {
      0% { transform: scale(1) }
      50% { transform: scale(0.9) }
      100% { transform: scale(1) }
    }
    .center.depleted { animation: pop 140ms ease-out; }

    /* Flowers */
    .flower { position: absolute; transform-origin: center; pointer-events: none; }
    .petal  { position: absolute; border-radius: 50%; opacity: 0.85; pointer-events: none; }
    .fill   {
      position: absolute; border-radius: 50%; background: orange;
      transform: scale(0); transform-origin: center; transition: transform 0.3s;
      z-index: 1; pointer-events: none;
    }
    .center {
      position: absolute; border-radius: 50%;
      background: gold; opacity: 0.5;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
      z-index: 2; transition: transform 0.12s ease;
      pointer-events: auto; cursor: pointer;
    }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-2px); }
      40% { transform: translateX(2px); }
      60% { transform: translateX(-2px); }
      80% { transform: translateX(2px); }
    }
    .no-honey { animation: shake 180ms linear; }
  </style>
</head>
<body>
  <h1>Honey Meadow üêù</h1>
  <div class="play-area" id="playArea"></div>
  <div class="stats">Your honey: <span class="value" id="honey">0</span></div>
  <!-- Admin panel will be injected if ?admin=true -->
  <script>
    const SERVER = "https://flowers-backend.htl.dev";
    const LEVEL_URL = SERVER + "/api/level";
    const ADMIN_RESTART_URL = SERVER + "/api/admin/restart";
    const HARVEST_URL = (id) => SERVER + "/api/harvest/" + id;
    const EVENTS_URL = SERVER + "/api/events";

    var levelData;

    const playArea = document.getElementById("playArea");
    const honeyEl = document.getElementById("honey");
    let userHoney = 0;

    /** Resize play area to maintain 9:16 aspect */
    function resizePlayArea() {
      const aspect = 9/16;
      const availableHeight = window.innerHeight - 80; 
      const availableWidth = window.innerWidth;
      let height = availableHeight;
      let width = height * aspect;
      if (width > availableWidth) {
        width = availableWidth;
        height = width / aspect;
      }
      playArea.style.width = width + "px";
      playArea.style.height = height + "px";
    }

    /** Create a flower */
    function createFlower(data) {
      const root = document.createElement("div");
      root.className = "flower";
      root.dataset.fill = data.fill;

      const areaW = playArea.clientWidth;
      const areaH = playArea.clientHeight;
      const px = data.x * areaW;
      const py = data.y * areaH;
      const size = data.size * areaH;

      root.style.width = size + "px";
      root.style.height = size + "px";
      root.style.left = px - size/2 + "px";
      root.style.top = py - size/2 + "px";

      // Petals
      for (let i = 0; i < data.petals; i++) {
        const petal = document.createElement("div");
        petal.className = "petal";
        petal.style.width = size * 0.6 + "px";
        petal.style.height = size * 0.6 + "px";
        petal.style.background = data.color;
        petal.style.top = size * 0.2 + "px";
        petal.style.left = size * 0.2 + "px";
        petal.style.transform = `rotate(${i * (360 / data.petals)}deg) translate(0, -${size * 0.3}px)`;
        root.appendChild(petal);
      }

      // Center + fill
      const centerSize = size * 0.35;
      const fillSize = centerSize * 1.1;

      const fillEl = document.createElement("div");
      fillEl.className = "fill";
      fillEl.style.width = fillSize + "px";
      fillEl.style.height = fillSize + "px";
      fillEl.style.top = (size - fillSize)/2 + "px";
      fillEl.style.left = (size - fillSize)/2 + "px";
      root.appendChild(fillEl);

      const centerEl = document.createElement("div");
      centerEl.className = "center";
      centerEl.style.width = centerSize + "px";
      centerEl.style.height = centerSize + "px";
      centerEl.style.top = (size - centerSize)/2 + "px";
      centerEl.style.left = (size - centerSize)/2 + "px";
      root.appendChild(centerEl);

      centerEl.addEventListener("click", async (ev) => {
        try {
          const res = await fetch(HARVEST_URL(f.id), { method: "POST" });
          if (!res.ok) return; // nichts hochz√§hlen

          const json = await res.json();
          const gained = Number(json.honey) || 0;

          if (gained > 0) {
            userHoney += Math.round(gained * 10);
            honeyEl.textContent = userHoney;

            const el = playArea.querySelector(`.flower[data-id="${json.flowerId}"]`);
            if (el) {
              el.dataset.fill = 0;
              updateFill(el);
            }
          } else {
            centerEl.classList.remove("no-honey"); void centerEl.offsetWidth; centerEl.classList.add("no-honey");
            if (navigator.vibrate) navigator.vibrate(15);
          }
        } catch (e) {
          console.error("harvest failed", e);
        }
      });

      updateFill(root);
      return root;
    }

    function updateFill(flowerEl) {
      const fillEl = flowerEl.querySelector(".fill");
      const fillValue = parseFloat(flowerEl.dataset.fill);
      fillEl.style.transform = `scale(${fillValue})`;
    }

    function refillFlowers() {
      document.querySelectorAll(".flower").forEach(flowerEl => {
        let val = parseFloat(flowerEl.dataset.fill);
        val = Math.min(1, val + (Math.random() * 0.05));
        flowerEl.dataset.fill = val;
        updateFill(flowerEl);
      });
    }

    async function fetchLevel() {
      try {
        const res = await fetch(LEVEL_URL);
        if (!res.ok) throw new Error("Failed to load level");
        levelData = await res.json();
      } catch (e) {
        console.error("Error fetching level", e);
      }
    }

    function buildLevel() {
      playArea.innerHTML = "";
      levelData.flowers.forEach(f => playArea.appendChild(createFlower(f)));
    }

    function init() {
      fetchLevel().then(buildLevel).then(resizePlayArea);
    }

    // Admin panel creation
    function initAdminPanel() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("admin") === "true") {
        const panel = document.createElement("div");
        panel.className = "admin-panel";
        panel.innerHTML = `<div>Admin Panel</div>
          <button id="restartBtn">Restart Level</button>`;
        document.body.appendChild(panel);

        document.getElementById("restartBtn").addEventListener("click", async () => {
          console.log("Sending restart command to server...");
          await fetch(ADMIN_RESTART_URL, { method: 'POST' });
          init();
        });
      }
    }

    // Init
    init();
    initAdminPanel();
    setInterval(refillFlowers, 2000);
    window.addEventListener("resize", init);

    const es = new EventSource(EVENTS_URL);
    es.onmessage = async (msg) => {
      const evt = JSON.parse(msg.data);
      if (evt.type === 'levelRestarted') {
        resizePlayArea();
        await fetchLevel();
        buildLevel();
      }
      if (evt.type === "harvest") {
        const id = evt.flowerId;
        if (!id) return;

        const flowerEl = playArea.querySelector(`.flower[data-id="${id}"]`);
        if (!flowerEl) return;

        flowerEl.dataset.fill = 0;
        updateFill(flowerEl);

        // some visual feedback
        const center = flowerEl.querySelector(".center");
        if (center) {
          center.classList.remove("depleted");
          void center.offsetWidth;                 // reflow to restart animation
          center.classList.add("depleted");
        }
      }
    };
  </script>
</body>
</html>
